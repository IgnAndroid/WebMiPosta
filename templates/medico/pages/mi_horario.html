{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mi Horario - Panel Médico · miPosta</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">

  <style>
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f4f7fb; }
    main, .section-padding { flex: 1 0 auto; }


    .card-custom { border-radius: 12px; box-shadow: 0 6px 18px rgba(16,24,40,0.06); }

    /* Force visible calendar area even if JS doesn't render events */
    #calendar {
      max-width: 100%;
      margin: 0 auto;
      min-height: 520px;            /* ensure visible area */
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(16,24,40,0.04);
      padding: 18px;
      box-sizing: border-box;
    }

    .fc .fc-toolbar-title { font-weight: 700; color: #0d6efd; }
    .fc .fc-button-primary { background: linear-gradient(135deg,#0d6efd 0%,#0a58ca 100%); border: none; box-shadow: none; }
    .fc-event.pendiente { background-color: #f59e0b; border-color: #f59e0b; color: #fff; }
    .fc-event.confirmada { background-color: #10b981; border-color: #10b981; color: #fff; }
    .fc-event.cancelada { background-color: #6b7280; border-color: #6b7280; color: #fff; }

    .btn-success-custom {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
      color: white;
    }

  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="{% url 'medico_dashboard' %}"><i class="fas fa-stethoscope me-2"></i>miPosta</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto me-3">
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_dashboard' %}"><i class="fas fa-home me-1"></i>Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_mis_citas' %}"><i class="fas fa-calendar-alt me-1"></i>Mis Citas</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_mis_pacientes' %}"><i class="fas fa-user-injured me-1"></i>Mis Pacientes</a></li>
          <li class="nav-item"><a class="nav-link active" href="{% url 'medico_horario' %}"><i class="fas fa-clock me-1"></i>Mi Horario</a></li>
        </ul>
        <div class="dropdown">
          <button class="btn btn-login dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-md me-1"></i>Dr. {{ user.get_full_name|default:user.username }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'medico_perfil' %}"><i class="fas fa-user me-2"></i>Mi Perfil</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="dashboard-header">
    <div class="container">
      <h1 class="mb-1"><i class="fas fa-clock me-2"></i>Mi Horario</h1>
      <p class="lead">Gestiona tus franjas disponibles y turnos</p>
    </div>
  </section>

  <!-- Main -->
  <main class="section-padding">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Calendario semanal</h5>

      </div>

      <div class="card card-custom p-3">
        <div id="calendar"></div>
      </div>
    </div>
  </main>

  <!-- Modal Agregar Franja -->
  <div class="modal fade" id="agregarFranjaModal" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" action="{% url 'medico_agregar_franja' %}">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Agregar Franja</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Día</label>
              <select name="dia" class="form-select" required>
                {% for d in dias_semana %}<option value="{{ d.key }}">{{ d.nombre }}</option>{% endfor %}
              </select>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Inicio</label>
                <input type="time" name="hora_inicio" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Fin</label>
                <input type="time" name="hora_fin" class="form-control" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Tipo</label>
              <select name="tipo" class="form-select">
                <option value="CONSULTA">Consulta</option>
                <option value="VACUNACION">Vacunación</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success-custom">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-custom">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
          <h5><i class="fas fa-stethoscope me-2"></i>miPosta</h5>
          <p class="text-mutedd">Sistema moderno de gestión de citas médicas.</p>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
          <h5>Enlaces Rápidos</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="{% url 'medico_mis_citas' %}">Mis Citas</a></li>
            <li class="mb-2"><a href="{% url 'medico_mis_pacientes' %}">Mis Pacientes</a></li>
            <li class="mb-2"><a href="{% url 'medico_horario' %}">Mi Horario</a></li>
          </ul>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
          <h5>Contacto</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-phone me-2"></i>(01) 234-5678</li>
            <li class="mb-2"><i class="fas fa-envelope me-2"></i>info@miposta.com</li>
          </ul>
        </div>
      </div>
      <hr class="my-4">
      <div class="row">
        <div class="col-12 text-center">
          <p class="text-muted mb-0">&copy; 2024 miPosta. Todos los derechos reservados.</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- calendar_events_json should be provided by the view -->
  <script id="calendar_events" type="application/json">{{ calendar_events_json|default:"[]"|safe }}</script>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <script>
    // Debug helper: prints status to console and below calendar if needed
    function logDebug(...args) { console.log('[mi_horario]', ...args); }

    function safeParseJSON(id) {
      const el = document.getElementById(id);
      if (!el) { logDebug('no element with id', id); return []; }
      try { return JSON.parse(el.textContent || '[]'); }
      catch (e) { console.error('JSON parse error for', id, e); return []; }
    }

    const eventsRaw = safeParseJSON('calendar_events');
    logDebug('eventsRaw length:', eventsRaw.length, eventsRaw);

    const fcEvents = (eventsRaw || []).map(ev => {
      const className = ev.estado === 'PENDIENTE' ? 'pendiente'
                      : ev.estado === 'CONFIRMADA' ? 'confirmada'
                      : ev.estado === 'CANCELADA' ? 'cancelada' : '';
      return {
        id: ev.id,
        title: ev.title,
        start: ev.start,
        end: ev.end,
        classNames: [className],
        extendedProps: { estado: ev.estado }
      };
    });

    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      if (!calendarEl) {
        logDebug('calendar element not found');
        return;
      }

      // Create FullCalendar, always render (even if fcEvents empty)
      try {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          headerToolbar: { left: 'title', right: 'today prev,next timeGridWeek dayGridMonth' },
          allDaySlot: false,
          slotMinTime: "06:00:00",
          slotMaxTime: "23:00:00",
          height: 'auto',
          events: fcEvents,
          editable: false,
          eventClick: function(info) {
            const ev = info.event;
            alert(`${ev.title}\nEstado: ${ev.extendedProps.estado}\nInicio: ${ev.start.toLocaleString()}`);
          }
        });

        calendar.render();
        logDebug('FullCalendar rendered, events count', fcEvents.length);
      } catch (err) {
        console.error('FullCalendar init error:', err);
        // show a simple fallback message inside calendarEl
        calendarEl.innerHTML = '<div style="padding:24px;color:#6b7280">No se pudo cargar el calendario (revisa la consola)</div>';
      }
    });
  </script>
</body>
</html>