{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mis Pacientes - Panel Médico · miPosta</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">

  <style>
    /* Estilos específicos manteniendo la paleta del proyecto */
    .patient-card { border-radius: 12px; }
    .avatar { width:56px;height:56px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:20px; }
    .no-results { min-height: 120px; display:flex; align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="{% url 'medico_dashboard' %}">
        <i class="fas fa-stethoscope me-2"></i>miPosta
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto me-3">
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_dashboard' %}"><i class="fas fa-home me-1"></i>Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_mis_citas' %}"><i class="fas fa-calendar-alt me-1"></i>Mis Citas</a></li>
          <li class="nav-item"><a class="nav-link active" href="{% url 'medico_mis_pacientes' %}"><i class="fas fa-user-injured me-1"></i>Mis Pacientes</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_horario' %}"><i class="fas fa-clock me-1"></i>Mi Horario</a></li>
        </ul>

        <div class="dropdown">
          <button class="btn btn-login dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-md me-1"></i>Dr. {{ user.get_full_name|default:user.username }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'medico_perfil' %}"><i class="fas fa-user me-2"></i>Mi Perfil</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="dashboard-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <h1 class="mb-1"><i class="fas fa-user-injured me-2"></i>Mis Pacientes</h1>
          <p class="lead mb-0">Ficha rápida de pacientes y acceso a historial clínico</p>
        </div>
        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
          <div class="d-inline-flex align-items-center gap-2">
            <span class="badge bg-white text-primary p-2 rounded">
              {% if pacientes.paginator %}
                {{ pacientes.paginator.count }}
              {% else %}
                {{ pacientes|length }}
              {% endif %}
            </span>
            <a href="#" class="btn btn-outline-light btn-sm">Exportar</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="section-padding">
    <div class="container">
      <div class="row mb-3 align-items-center">
        <div class="col-lg-8">
          <div class="input-group">
            <input id="searchPatient" class="form-control" placeholder="Buscar paciente por nombre..." aria-label="Buscar pacientes">
            <button id="clearSearch" class="btn btn-outline-secondary" type="button" title="Limpiar búsqueda"><i class="fas fa-times"></i></button>
          </div>
        </div>
 
      </div>

      {% if pacientes %}
      <div class="row g-3">
        {% for p in pacientes %}
        <div class="col-md-6 col-lg-4">
          <article class="p-3 bg-white patient-card shadow-sm card-custom h-100">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <div class="avatar bg-primary text-white">
                  {% if p.first_name %}
                    {{ p.first_name|slice:":1"|upper }}
                  {% else %}
                    <i class="fas fa-user"></i>
                  {% endif %}
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0">{{ p.get_full_name|default:p.username }}</h6>
                <small class="text-muted d-block">{{ p.email|default:"-" }}</small>
                <small class="text-muted d-block">Tel: {{ p.telefono|default:"-" }}</small>
              </div>
            </div>

            <hr class="my-3">

            <div class="d-flex justify-content-between">
              {# Resolver URL de detalle de paciente de forma segura (no lanzar NoReverseMatch) #}
              {% url 'medico_paciente_detail' p.id as paciente_url %}
              <a href="{{ paciente_url|default:'#' }}" class="btn btn-sm btn-outline-secondary">Ver Ficha</a>

              {# Resolver URL de agendar de forma segura #}
              {% url 'medico_agendar' p.id as agendar_url %}
              <a href="{{ agendar_url|default:'#' }}" class="btn btn-sm btn-primary">Agendar</a>
            </div>
          </article>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if pacientes.has_other_pages %}
      <div class="mt-4 d-flex justify-content-between align-items-center">
        <div class="text-muted small">Mostrando {{ pacientes.start_index }} - {{ pacientes.end_index }} de {{ pacientes.paginator.count }}</div>
        <nav aria-label="Paginación de pacientes">
          <ul class="pagination mb-0">
            {% if pacientes.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ pacientes.previous_page_number }}">« Anterior</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">« Anterior</span></li>
            {% endif %}

            {% for num in pacientes.paginator.page_range %}
              {% if num >= pacientes.number|add:'-2' and num <= pacientes.number|add:'2' %}
                <li class="page-item {% if num == pacientes.number %}active{% endif %}">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if pacientes.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ pacientes.next_page_number }}">Siguiente »</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Siguiente »</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}

      {% else %}
      <div class="card card-custom bg-white p-4 no-results">
        <div class="text-center w-100">
          <i class="fas fa-user-injured fa-2x text-muted mb-2"></i>
          <p class="mb-0 text-muted">No hay pacientes asignados.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer-custom mt-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
          <h5><i class="fas fa-stethoscope me-2"></i>miPosta</h5>
          <p class="text-mutedd">Sistema moderno de gestión de citas médicas.</p>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
          <h5>Enlaces Rápidos</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="{% url 'medico_mis_citas' %}">Mis Citas</a></li>
            <li class="mb-2"><a href="{% url 'medico_mis_pacientes' %}">Mis Pacientes</a></li>
            <li class="mb-2"><a href="{% url 'medico_horario' %}">Mi Horario</a></li>
          </ul>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
          <h5>Contacto</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-phone me-2"></i>(01) 234-5678</li>
            <li class="mb-2"><i class="fas fa-envelope me-2"></i>info@miposta.com</li>
          </ul>
        </div>
      </div>
      <hr class="my-4" style="opacity: 0.12;">
      <div class="row">
        <div class="col-12 text-center">
          <p class="text-mutedd mb-0">&copy; 2024 miPosta. Todos los derechos reservados.</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const searchInput = document.getElementById('searchPatient');
      const clearBtn = document.getElementById('clearSearch');

      function normalize(text) {
        return (text || '').toLowerCase();
      }

      function applySearch() {
        const q = normalize(searchInput ? searchInput.value : '');
        document.querySelectorAll('.patient-card').forEach(card => {
          const text = normalize(card.innerText);
          card.parentElement.style.display = q === '' || text.includes(q) ? '' : 'none';
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', applySearch);
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          if (searchInput) searchInput.value = '';
          applySearch();
          searchInput && searchInput.focus();
        });
      }
    })();
  </script>
</body>
</html>