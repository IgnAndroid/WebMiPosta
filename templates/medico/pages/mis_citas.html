{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mis Citas - Panel Médico · miPosta</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">

    <style>
        /* FIX: eliminar línea/espacio blanco debajo del footer y pegar footer al fondo */
        html, body {
        height: 100%;
        margin: 0; /* quita el margen por defecto del body */
        }

        body {
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* asegura que el body siempre ocupe toda la ventana */
        background-color: #f4f7fb; /* ajusta al color de fondo de tu layout (opcional) */
        }

        /* Haz que el contenido principal empuje el footer hacia abajo */
        main, .content, .section-padding {
        flex: 1 0 auto;
        }

        /* Asegura que el footer no tenga margen inferior y ocupe el ancho */
        .footer-custom {
        margin-top: auto;
        color: #ffffff;
        width: 100%;
        padding-top: 2.5rem;
        padding-bottom: 2.5rem;
        box-sizing: border-box;
        }

        /* Si existe un <hr> en el footer que genera separación visual, controla su estilo */
        .footer-custom hr {
        margin: 1.5rem 0;
        border: none;
        }    
</style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="{% url 'medico_dashboard' %}">
        <i class="fas fa-stethoscope me-2"></i>miPosta
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto me-3">
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_dashboard' %}"><i class="fas fa-home me-1"></i>Inicio</a></li>
          <li class="nav-item"><a class="nav-link active" href="{% url 'medico_mis_citas' %}"><i class="fas fa-calendar-alt me-1"></i>Mis Citas</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_mis_pacientes' %}"><i class="fas fa-user-injured me-1"></i>Mis Pacientes</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'medico_horario' %}"><i class="fas fa-clock me-1"></i>Mi Horario</a></li>
        </ul>

        <div class="dropdown">
          <button class="btn btn-login dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-md me-1"></i>Dr. {{ user.get_full_name|default:user.username }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'medico_perfil' %}"><i class="fas fa-user me-2"></i>Mi Perfil</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="dashboard-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <h1 class="mb-1"><i class="fas fa-calendar-alt me-2"></i>Mis Citas</h1>
          <p class="lead mb-0">Lista completa de citas — filtra y administra con un solo clic.</p>
        </div>
        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
          <a href="{% url 'medico_mis_citas' %}" class="btn btn-outline-light">Actualizar</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <div class="section-padding">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2 w-75">
          <input id="q" class="form-control form-control-sm" placeholder="Buscar paciente, motivo..." aria-label="Buscar citas">
          <select id="filtroEstado" class="form-select form-select-sm w-auto" aria-label="Filtrar por estado">
            <option value="">Todos</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="CONFIRMADA">Confirmada</option>
            <option value="CANCELADA">Cancelada</option>
            <option value="COMPLETADA">Completada</option>
          </select>
        </div>
        <div>
          <a href="{% url 'medico_mis_citas' %}" class="btn btn-outline-primary btn-sm">Recargar</a>
        </div>
      </div>

      {% if mis_citas %}
      <div class="table-responsive bg-white rounded shadow-sm p-3 card-custom">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Fecha / Hora</th>
              <th>Paciente</th>
              <th>Motivo</th>
              <th>Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="citasBody">
            {% for cita in mis_citas %}
            <tr data-estado="{{ cita.estado }}">
              <td>
                <strong>{{ cita.fecha_hora|date:"d/m/Y" }}</strong>
                <br>
                <small class="text-muted">{{ cita.fecha_hora|date:"H:i" }}</small>
              </td>
              <td>{{ cita.paciente.get_full_name|default:cita.paciente.username }}</td>
              <td>{{ cita.motivo|truncatewords:10 }}</td>
              <td>
                {% if cita.estado == 'PENDIENTE' %}
                  <span class="badge bg-warning">Pendiente</span>
                {% elif cita.estado == 'CONFIRMADA' %}
                  <span class="badge bg-success">Confirmada</span>
                {% elif cita.estado == 'CANCELADA' %}
                  <span class="badge bg-secondary">Cancelada</span>
                {% else %}
                  <span class="badge bg-info">{{ cita.estado }}</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a href="{% url 'medico_cita_detail' cita.id %}" class="btn btn-sm btn-outline-secondary action-btn" title="Ver"><i class="fas fa-eye"></i></a>

                {% if cita.estado == 'PENDIENTE' %}
                  <button type="button" class="btn btn-sm btn-success action-btn" data-id="{{ cita.id }}" data-action="confirm" title="Confirmar"><i class="fas fa-check"></i></button>
                  <button type="button" class="btn btn-sm btn-danger action-btn" data-id="{{ cita.id }}" data-action="cancel" title="Cancelar"><i class="fas fa-times"></i></button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación (si tu queryset está paginado) -->
      {% if mis_citas.has_other_pages %}
      <div class="mt-3 d-flex justify-content-end">
        <nav aria-label="Paginación de citas">
          <ul class="pagination mb-0">
            {% if mis_citas.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ mis_citas.previous_page_number }}">Anterior</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">Página {{ mis_citas.number }} de {{ mis_citas.paginator.num_pages }}</span></li>
            {% if mis_citas.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ mis_citas.next_page_number }}">Siguiente</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}

      {% else %}
      <div class="alert alert-info">No hay citas registradas.</div>
      {% endif %}
    </div>
</div>



    <!-- Footer -->
    <footer class="footer-custom">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5><i class="fas fa-stethoscope me-2"></i>miPosta</h5>
                    <p class="text-mutedd">Sistema moderno de gestión de citas médicas.</p>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5>Enlaces Rápidos</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="{% url 'medico_mis_citas' %}">Mis Citas</a></li>
                        <li class="mb-2"><a href="{% url 'medico_mis_pacientes' %}">Mis Pacientes</a></li>
                        <li class="mb-2"><a href="{% url 'medico_horario' %}">Mi Horario</a></li>
                    </ul>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5>Contacto</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-phone me-2"></i>(01) 234-5678</li>
                        <li class="mb-2"><i class="fas fa-envelope me-2"></i>info@miposta.com</li>
                    </ul>
                </div>
            </div>
            <hr class="my-4" style="opacity: 0.3;">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="text-mutedd mb-0">&copy; 2024 miPosta. Todos los derechos reservados.</p>
                </div>
            </div>
        </div>
    </footer>



  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Obtener CSRF token desde cookie (Django)
    function getCookie(name) {
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return null;
    }
    const csrftoken = getCookie('csrftoken');

    // Delegación para botones confirmar/cancelar
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action'); // 'confirm' | 'cancel'
      if (!id || !action) return;

      const confirmMsg = action === 'confirm' ? '¿Confirmar esta cita?' : '¿Cancelar esta cita?';
      if (!confirm(confirmMsg)) return;

      const endpoint = action === 'confirm' ? 'confirmar' : 'cancelar';
      const url = `/medico/citas/${id}/${endpoint}/`;

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Network response not ok');
        // try to parse json, but some endpoints might not return body
        return response.json().catch(()=>({success: true}));
      })
      .then(data => {
        if (data && data.success === false) {
          alert(data.error || 'Ocurrió un error al procesar la petición');
        } else {
          // reload para reflejar cambios
          location.reload();
        }
      })
      .catch(err => {
        console.error(err);
        alert('Ocurrió un error al procesar la petición');
      });
    });

    // Búsqueda y filtro cliente (mejor experiencia)
    (function () {
      const qInput = document.getElementById('q');
      const filtroEstado = document.getElementById('filtroEstado');
      const rows = () => Array.from(document.querySelectorAll('#citasBody tr'));

      function applyFilters() {
        const q = qInput ? qInput.value.trim().toLowerCase() : '';
        const estado = filtroEstado ? filtroEstado.value : '';

        rows().forEach(tr => {
          const text = tr.innerText.toLowerCase();
          const rowEstado = tr.getAttribute('data-estado') || '';
          const matchesQuery = q === '' || text.includes(q);
          const matchesEstado = estado === '' || rowEstado === estado;
          tr.style.display = (matchesQuery && matchesEstado) ? '' : 'none';
        });
      }

      if (qInput) qInput.addEventListener('input', applyFilters);
      if (filtroEstado) filtroEstado.addEventListener('change', applyFilters);
    })();
  </script>
</body>
</html>